# Adaptive Periodic PINN for V0=40V regime
# Usage: python -m src.trainer fit --config configs/periodic_v40_adaptive.yaml

# Experiment settings
auto_name: true
output_dir: ./experiments

# Model configuration
model:
  class_path: src.model.AdaptiveSequentialPeriodicPINN
  init_args:
    # Architecture
    hidden_layers: [256, 256, 256]
    activation: tanh
    num_ffm_frequencies: 2
    max_t_harmonic: 4
    exact_bc: true
    use_exp_ne: true

    # Physics
    params_path: configs/physics/v40.yaml
    smooth_reaction_zone: true
    reaction_sharpness: 100.0

    # Residual normalization (modular)
    # Strategies: none, ema, char_scale, running_stats, batch_norm
    normalize_residuals: true
    use_ema_normalization: true  # Maps to residual_norm_strategy: ema
    ema_decay: 0.99  # Slow decay = stable (0.99 = 99% old + 1% new)

    # Optimization
    learning_rate: 1e-4
    optimizer: adam
    scheduler: constant
    weight_decay: 0.0

    # Soft n_e BC: FDM-consistent boundary (n_e at boundaries evolved by PDE)
    soft_bc_ne: true  # Default true - matches FDM physics

    # Loss balancing (modular)
    loss_weights:
      continuity: 1.0
      poisson: 1.0
      bc: 10.0
      ic: 0.0
      ne_bc: 1.0  # Soft n_e BC loss - penalizes large boundary n_e values
    # Adaptive loss balancing
    # Strategies: max, mean, rms, softmax
    use_adaptive_weights: true
    adaptive_alpha: 0.1  # Slow EMA = stable (0.1 = 90% old + 10% new)
    balancing_strategy: mean  # More stable than max
    max_weight: 100.0  # Cap to prevent explosion
    min_weight: 0.01   # Floor to prevent collapse

    # Gradient surgery (optional - for conflicting gradients)
    use_pcgrad: false

    # Output
    visualize_on_train_end: true

# Data configuration
data:
  batch_size: 10000
  num_points: 10000
  sampler_type: uniform
  x_range: [0.0, 1.0]
  t_range: [0.0, 1.0]
  clamp_x: false
  val_grid_size: 100
  num_workers: 0

# Trainer configuration
trainer:
  max_epochs: 10000
  accelerator: auto
  devices: 1
  precision: 32
  gradient_clip_val: 1.0
  log_every_n_steps: 10
  check_val_every_n_epoch: 10
  enable_progress_bar: true
  enable_model_summary: true

# Logging
use_wandb: false
wandb_project: pinn-ccp2-adaptive
